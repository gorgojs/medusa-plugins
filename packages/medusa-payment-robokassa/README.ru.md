<p align="center">
  <a href="https://www.medusajs.com">
    <picture>
      <source media="(prefers-color-scheme: dark)" srcset="https://github.com/user-attachments/assets/119f3faf-da2e-476e-bf08-6e557de689b6">
      <source media="(prefers-color-scheme: light)" srcset="https://github.com/user-attachments/assets/119f3faf-da2e-476e-bf08-6e557de689b6">
      <img alt="Medusa-Robokassa logo" src="https://github.com/user-attachments/assets/119f3faf-da2e-476e-bf08-6e557de689b6" height="120">
    </picture>
  </a>
</p>

<h1 align="center">
Robokassa Payments –¥–ª—è Medusa
</h1>

<p align="center">
–ü–ª–∞–≥–∏–Ω –¥–ª—è Medusa, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ Robokassa.
</p>

<p align="center">
  <a href="https://medusajs.com">
    <img src="https://img.shields.io/badge/Medusa-^2.7.0-blue?logo=medusa" alt="Medusa" />
  </a>
  <a href="https://medusajs.com">
    <img src="https://img.shields.io/badge/Tested_with_Medusa-v2.9.0-green?logo=checkmarx" alt="Medusa" />
  </a>
</p>

<p align="center">
  <a href="https://t.me/medusajs_robokassa">
    <img src="https://img.shields.io/badge/Telegram-Medusa.js‚ä∑Robokassa_Support_Chat-0088cc?logo=telegram&style=social" alt="Medusa.js‚ä∑Robokassa on Telegram" />
  </a>
</p>

<p align="center">
  <a href="https://t.me/medusajs_chat">
    <img src="https://img.shields.io/badge/Telegram-Medusa.js_Dev_Community_Chat-0088cc?logo=telegram&style=social" alt="Medusa.js Chat on Telegram" />
  </a>
</p>

> [Read README in English](./README.md)

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

üõí **–ë–µ—Å—à–æ–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π Robokassa  
üí≥ **–û–¥–Ω–æ—Å—Ç–∞–¥–∏–π–Ω—ã–µ** (–∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–µ) –∏ **–¥–≤—É—Ö—Å—Ç–∞–¥–∏–π–Ω—ã–µ** (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è/—Ö–æ–ª–¥) —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ–ø–ª–∞—Ç—ã  
üîÑ **–ü–æ–ª–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—Ç—ã** –∏ **–æ—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞**  
üìä **Webhook-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏  
üõ° **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook‚Äô–æ–≤** –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏  
‚öôÔ∏è **–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º** ‚Äî –∏–º–∏—Ç–∞—Ü–∏—è –æ–ø–ª–∞—Ç—ã –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π  
üîß **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –∞—É–¥–∏—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π  

## üí¨ –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–ª–∞–≥–∏–Ω–∞ –≤ Telegram

–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —á–∞—Ç—É [Medusa.js ‚ä∑ Robokassa](https://t.me/medusajs_robokassa), —á—Ç–æ–±—ã –æ–±—Å—É–∂–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ø–æ–ª—É—á–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É.

## üë• –°–æ–æ–±—â–µ—Å—Ç–≤–æ Medusa.js –≤ Telegram

–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ [Medusa.js Chat](https://t.me/medusajs_chat), —á—Ç–æ–±—ã –æ–±—â–∞—Ç—å—Å—è —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏, —Å–æ–∑–¥–∞—é—â–∏–º–∏ –ø—Ä–æ–µ–∫—Ç—ã –Ω–∞ Medusa.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Medusa server v2.7.0 –∏–ª–∏ –Ω–æ–≤–µ–µ  
- Node.js v20 –∏–ª–∏ –Ω–æ–≤–µ–µ  
- –ê–∫–∫–∞—É–Ω—Ç Robokassa ‚Äî [–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ](https://login.robokassa.ru/reg?promoCode=gorgo)

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
yarn add @gorgo/medusa-payment-robokassa
# –∏–ª–∏
npm install @gorgo/medusa-payment-robokassa
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –≤ `medusa-config.js` –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Medusa:

```js
// ...
module.exports = defineConfig({
  // ...
  modules: [
    {
      resolve: "@medusajs/medusa/payment",
      options: {
        providers: [
          {
            resolve: "@gorgo/medusa-payment-robokassa/providers/payment-robokassa",
            id: "robokassa",
            options: {
              merchantLogin: process.env.ROBOKASSA_MERCHANT_LOGIN,
              hashAlgorithm: process.env.ROBOKASSA_HASH_ALGORITHM,
              password1: process.env.ROBOKASSA_PASSWORD_1,
              password2: process.env.ROBOKASSA_PASSWORD_2,
              testPassword1: process.env.ROBOKASSA_TEST_PASSWORD_1,
              testPassword2: process.env.ROBOKASSA_TEST_PASSWORD_2,
              capture: false,  // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true
              isTest: true,    // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false
            },
          }   
        ]
      }
    }
  ]
})
```

–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ `merchantLogin`, –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏ `hashAlgorithm`, —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ `password1`, `password2`, –∞ —Ç–∞–∫–∂–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ `testPassword1`, `testPassword2`:

```
ROBOKASSA_MERCHANT_LOGIN=test-shop
ROBOKASSA_HASH_ALGORITHM=md5
ROBOKASSA_PASSWORD_1=supersecret
ROBOKASSA_PASSWORD_2=supersecret
ROBOKASSA_TEST_PASSWORD_1=supersecret
ROBOKASSA_TEST_PASSWORD_2=supersecret
```

> **–í–∞–∂–Ω–æ!** –ó–Ω–∞—á–µ–Ω–∏–µ `ROBOKASSA_HASH_ALGORITHM` –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π –≤ –∞–∫–∫–∞—É–Ω—Ç–µ Robokassa –∏ –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑: `md5`, `sha1`, `sha256`, `sha384`, `sha512` –∏–ª–∏ `ripemd160` (–æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –¥–ª—è `ripemd160` –≤–æ–∑–º–æ–∂–Ω—ã –æ—à–∏–±–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞).

–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –º–∞–≥–∞–∑–∏–Ω–∞ Robokassa —É–∫–∞–∂–∏—Ç–µ **–ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ Result URL** ‚Äî `GET` –∏–ª–∏ `POST`, –∏ –∑–∞–¥–∞–π—Ç–µ **Result URL** –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

```
https://{YOUR_MEDUSA_DOMAIN}/hooks/payment/robokassa_robokassa
```

## –û–ø—Ü–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

| –û–ø—Ü–∏—è            | –û–ø–∏—Å–∞–Ω–∏–µ                                                                 | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------------|--------------------------------------------------------------------------|-------------|--------------|
| `merchantLogin`  | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ Robokassa                                         | –î–∞          | -            |
| `hashAlgorithm`  | –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏: `md5`, `sha1`, `sha256`, `sha384`, `sha512`            | –î–∞          | -            |
| `password1`      | –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–∞—Ä–æ–ª—å ‚Ññ1 –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–∞      | –î–∞         | -            |
| `password2`      | –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–∞—Ä–æ–ª—å ‚Ññ2 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö –æ–± –æ–ø–ª–∞—Ç–µ      | –î–∞         | -            |
| `testPassword1`  | –¢–µ—Å—Ç–æ–≤—ã–π –ø–∞—Ä–æ–ª—å ‚Ññ1 –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ *(–µ—Å–ª–∏ `isTest=true`)*  | –ù–µ—Ç         | -            |
| `testPassword2`  | –¢–µ—Å—Ç–æ–≤—ã–π –ø–∞—Ä–æ–ª—å ‚Ññ2 –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ *(–µ—Å–ª–∏ `isTest=true`)* | –ù–µ—Ç       | -            |
| `capture`        | –ê–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–µ: `true` ‚Äî 1‚Äë—Å—Ç–∞–¥–∏–π–Ω–æ; `false` ‚Äî –ø—Ä–µ–¥–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–¥–≤—É—Ö—Å—Ç–∞–¥–∏–π–Ω–æ) | –ù–µ—Ç       | `true`       |
| `isTest`         | –í–∫–ª—é—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º                                                   | –ù–µ—Ç         | `false`      |

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ storefront

–ß—Ç–æ–±—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Robokassa –≤ –≤–∏—Ç—Ä–∏–Ω—É Next.js, —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ UI‚Äë–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Ä—è–¥–æ–º —Å –¥—Ä—É–≥–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏.

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç Robokassa, –≤–∏—Ç—Ä–∏–Ω–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `initiatePaymentSession` —Å –Ω—É–∂–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏. –ë—ç–∫–µ–Ω–¥ Medusa —Å–æ–∑–¥–∞—ë—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ—ë –≤ –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–µ—Å—Å–∏–∏. –ö–Ω–æ–ø–∫–∞ *Place order* –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ö–æ—Å—Ç‚Äë—Å—Ç—Ä–∞–Ω–∏—Ü—É Robokassa. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–ø—ã—Ç–∫–∏ –æ–ø–ª–∞—Ç—ã Robokassa –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—Ä–∞—Ç–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (ResultURL). –ß—Ç–æ –±—ã –Ω–∏ –ø—Ä–∏—à–ª–æ —Ä–∞–Ω—å—à–µ, –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ (–æ–±—ã—á–Ω–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ª–∞–µ—Ç—Å—è –ø–æ ResultURL).

–î–ª—è Next.js Starter –≤–Ω–µ—Å–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

–°–¥–µ–ª–∞–π—Ç–µ Robokassa –¥–æ—Å—Ç—É–ø–Ω–æ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ checkout ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –µ—ë –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –º–∞–ø–ø–∏–Ω–≥ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –≤–∏—Ç—Ä–∏–Ω—ã. –≠—Ç–æ—Ç –º–∞–ø–ø–∏–Ω–≥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∏–∫–æ–Ω–∫—É –≤ UI.

–û—Ç–∫—Ä–æ–π—Ç–µ [`src/lib/constants.tsx`](https://github.com/gorgojs/medusa-plugins/blob/f2e1073275317a01f1447efe9a87d6bc135c5b61/examples/payment-robokassa/medusa-storefront/src/lib/constants.tsx#L33-L36) –∏ –¥–æ–±–∞–≤—å—Ç–µ:

![Directory structure in the Medusa Storefront after updating the file for constants](https://github.com/user-attachments/assets/0aee001e-958f-40c6-b329-618e318ff019)

```ts
export const paymentInfoMap: Record<
  string,
  { title: string; icon: React.ReactNode }
> = {
  // ... other providers
  pp_robokassa_robokassa: {
    title: "Robokassa",
    icon: <CreditCard />,
  }
}

// Helper to check if a provider is Robokassa
export const isRobokassa = (providerId?: string) => {
  return providerId?.startsWith("pp_robokassa")
}
```

–í—ã —Ä–∞—Å—à–∏—Ä—è–µ—Ç–µ –æ–±—ä–µ–∫—Ç `paymentInfoMap`, –¥–æ–±–∞–≤–ª—è—è –∑–∞–ø–∏—Å—å `pp_robokassa_robokassa`. –≠—Ç–∞ –∑–∞–ø–∏—Å—å –∑–∞–¥–∞—ë—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∏–∫–æ–Ω–∫—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.

–•–µ–ª–ø–µ—Ä `isRobokassa` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ `providerId` –∫ Robokassa. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ UI –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —à–∞–≥–∞ –æ–ø–ª–∞—Ç—ã –∫ –Ω—É–∂–Ω–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É.

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ cookie

–ü—Ä–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Robokassa –æ—Å–ª–∞–±—å—Ç–µ –ø–æ–ª–∏—Ç–∏–∫—É cookie –¥–ª—è –∫—Ä–æ—Å—Å‚Äë–¥–æ–º–µ–Ω–Ω—ã—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `SameSite: "lax"`, —á—Ç–æ–±—ã –∫–æ—Ä–∑–∏–Ω–Ω–∞—è cookie –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∞—Å—å –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã Robokassa –∏ —Å–µ—Å—Å–∏—è –Ω–µ —Ç–µ—Ä—è–ª–∞—Å—å.

–û—Ç–∫—Ä–æ–π—Ç–µ [`src/lib/data/cookies.ts`](https://github.com/gorgojs/medusa-plugins/blob/f2e1073275317a01f1447efe9a87d6bc135c5b61/examples/payment-robokassa/medusa-storefront/src/lib/data/cookies.ts#L79) –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

![Directory structure in the Medusa Storefront after updating the file for cookies](https://github.com/user-attachments/assets/4274d249-6994-4d9f-b4b6-98f2016f0e9f)

```ts
export const setCartId = async (cartId: string) => {
  cookies.set("_medusa_cart_id", cartId, {
    // ... other cookie settings
    sameSite: "lax", // Changed from "strict" for payment redirects
  })
}
```

–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ—Ä–∑–∏–Ω—ã –≤ cookie `_medusa_cart_id`. –ó–Ω–∞—á–µ–Ω–∏–µ `lax` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É cookie –ø—Ä–∏ –∫—Ä–æ—Å—Å‚Äë—Å–∞–π—Ç–æ–≤–æ–º –≤–æ–∑–≤—Ä–∞—Ç–µ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã.

### 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–µ—Å—Å–∏–∏

–ß—Ç–æ–±—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ Robokassa, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–µ—Å—Å–∏—é —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è success/fail‚ÄëURL, —è–∑—ã–∫–∞ –∏ email.

–û—Ç–∫—Ä–æ–π—Ç–µ [`src/modules/checkout/components/payment/index.tsx`](https://github.com/gorgojs/medusa-plugins/blob/f2e1073275317a01f1447efe9a87d6bc135c5b61/examples/payment-robokassa/medusa-storefront/src/modules/checkout/components/payment/index.tsx#L89-L96) –∏ –¥–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏–∫—É —Å redirect‚Äë–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ Robokassa:

![Directory structure in the Medusa Storefront after updating the file for payment component](https://github.com/user-attachments/assets/5c4dfcf9-57e7-48f6-956c-0e0a91ec6c8f)

```ts
await initiatePaymentSession(cart, {
  provider_id: selectedPaymentMethod,
  data: {
    SuccessUrl2: `${getBaseURL()}/api/capture-payment/${cart?.id}?country_code=${countryCode}`,
    SuccessUrl2Method: "GET",
    FailUrl2: `${getBaseURL()}/api/capture-payment/${cart?.id}?country_code=${countryCode}`,
    FailUrl2Method: "GET",
    EMail: cart?.email,
    Culture: countryCode === "ru" ? "ru" : "en",
  }
})
```

–ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Robokassa –≤–∞—à –±—ç–∫–µ–Ω–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π **payment URL** (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Å–µ—Å—Å–∏–∏), –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –≤–∏—Ç—Ä–∏–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç. –ó–∞—Ç–µ–º Robokassa –≤–µ—Ä–Ω—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ `SuccessUrl2`/`FailUrl2` –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ –≤–∞—à `ResultURL` –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.

### 4. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã

–í–∏—Ç—Ä–∏–Ω–∞ Medusa —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –Ω–∞ —à–∞–≥–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –î–ª—è Robokassa –∫–Ω–æ–ø–∫–∞ —á–∏—Ç–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–ª–∞—Ç—ë–∂–Ω—É—é —Å–µ—Å—Å–∏—é –∏ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ `paymentUrl` –∏–∑ `session.data`.

–û—Ç–∫—Ä–æ–π—Ç–µ [`src/modules/checkout/components/payment-button/index.tsx`](https://github.com/gorgojs/medusa-plugins/blob/f2e1073275317a01f1447efe9a87d6bc135c5b61/examples/payment-robokassa/medusa-storefront/src/modules/checkout/components/payment-button/index.tsx#L163-L211) –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:

![Directory structure in the Medusa Storefront after updating the file for payment button component](https://github.com/user-attachments/assets/4b76ee52-747f-452e-9160-6365f742e33e)

```ts
const PaymentButton: React.FC<PaymentButtonProps> = ({
  cart,
  "data-testid": dataTestId,
}) => {
  // ...
  switch (true) {
    // ... other cases
    case isRobokassa(paymentSession?.provider_id):
      return (
        <RobokassaPaymentButton
          notReady={notReady}
          cart={cart}
          data-testid={dataTestId}
        />
      )
    default:
      return <Button disabled>Select a payment method</Button>
  }
}

// ... other payment button's components

type RobokassaPaymentProps = {
  cart: HttpTypes.StoreCart
  notReady: boolean
  "data-testid"?: string
}

const RobokassaPaymentButton: React.FC<RobokassaPaymentProps> = ({
  cart,
  notReady,
  "data-testid": dataTestId,
}) => {
  const [submitting, setSubmitting] = useState(false)
  const [errorMessage, setErrorMessage] = useState<string | null>(null)
  const router = useRouter()

  const paymentSession = cart.payment_collection?.payment_sessions?.find(
    session =>
      session.provider_id === "pp_robokassa_robokassa"
  )

  const handlePayment = () => {
    setSubmitting(true)
    const paymentUrl = (paymentSession?.data as any).paymentUrl
    if (paymentUrl) {
      router.push(paymentUrl)
    } else {
      setErrorMessage("Payment URL –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
      setSubmitting(false)
    }
  }

  return (
    <>
      <Button
        disabled={notReady}
        isLoading={submitting}
        onClick={handlePayment}
        data-testid={dataTestId}
        size="large"
      >
        Place order
      </Button>
      <ErrorMessage
        error={errorMessage}
        data-testid="robokassa-payment-error-message"
      />
    </>
  )
}
```

–≠—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞—Ö–æ–¥–∏—Ç –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ—Ä–∑–∏–Ω–µ –ø–ª–∞—Ç—ë–∂–Ω—É—é —Å–µ—Å—Å–∏—é Robokassa –∏ —á–∏—Ç–∞–µ—Ç `data.paymentUrl`. –ü—Ä–∏ –∫–ª–∏–∫–µ –ø–æ *Place order* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ—Ç URL, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ–ø–ª–∞—Ç—É –Ω–∞ —Ö–æ—Å—Ç‚Äë—Å—Ç—Ä–∞–Ω–∏—Ü–µ Robokassa.

–ï—Å–ª–∏ `paymentUrl` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥. –°–æ—Å—Ç–æ—è–Ω–∏–µ `isLoading` –¥–∞—ë—Ç –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å, –ø–æ–∫–∞ –≥–æ—Ç–æ–≤–∏—Ç—Å—è —Ä–µ–¥–∏—Ä–µ–∫—Ç.

–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π `PaymentButton` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `isRobokassa`, —á—Ç–æ–±—ã –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å `RobokassaPaymentButton` –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏; –∏–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ *Select a payment method*.

### 5. –≠–Ω–¥–ø–æ–∏–Ω—Ç –∑–∞—Ö–≤–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ (capture)

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Robokassa –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –≤–∏—Ç—Ä–∏–Ω—É. –ù—É–∂–µ–Ω API‚Äë–º–∞—Ä—à—Ä—É—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ—Ç –∫–æ–ª–±—ç–∫, –ø—Ä–æ–≤–µ—Ä–∏—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç –∫–æ—Ä–∑–∏–Ω—É.

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª [`src/app/api/capture-payment/[cartId]/route.ts`](https://github.com/gorgojs/medusa-plugins/blob/main/examples/payment-robokassa/medusa-storefront/src/app/api/capture-payment/%5BcartId%5D/route.ts) —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

![Directory structure in the Medusa Storefront after creating the file for API route](https://github.com/user-attachments/assets/89ac89de-62ad-4b6c-af61-ab6299587dbf)

```ts
import { NextRequest, NextResponse } from "next/server"
import { revalidateTag } from "next/cache"
import {
  getCacheTag,
  getAuthHeaders,
  removeCartId
} from "@lib/data/cookies"
import { sdk } from "@lib/config"
import { placeOrder } from "@lib/data/cart"

type Params = Promise<{ cartId: string }>

export async function GET(req: NextRequest, { params }: { params: Params }) {
  const { cartId } = await params
  const { origin, searchParams } = req.nextUrl

  const countryCode = searchParams.get("country_code") || ""
  const headers = { ...(await getAuthHeaders()) }

  // Retrieve fresh cart values
  const cartCacheTag = await getCacheTag("carts")
  revalidateTag(cartCacheTag)
  const { cart } = await sdk.store.cart.retrieve(cartId, {
    fields: "id, order_link.order_id"
  },
    headers
  )
  if (!cart) {
    return NextResponse.redirect(`${origin}/${countryCode}`)
  }

  const orderId = (cart as unknown as Record<string, any>).order_link?.order_id
  if (!orderId) {
    await placeOrder(cartId)
    // Fail when payment not authorized
    return NextResponse.redirect(
      `${origin}/${countryCode}/checkout?step=review&error=payment_failed`
    )
  }

  const orderCacheTag = await getCacheTag("orders")
  revalidateTag(orderCacheTag)
  removeCartId()
  return NextResponse.redirect(
    `${origin}/${countryCode}/order/${orderId}/confirmed`
  )
}
```

–≠—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å Robokassa –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –æ–ø–ª–∞—Ç—ã. –û–Ω –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã, —á—Ç–æ–±—ã —É—á–µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–ª–∞—Ç–µ–∂–∞.

–ï—Å–ª–∏ —É –∫–æ—Ä–∑–∏–Ω—ã –Ω–µ—Ç —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ `order_id`, –º–∞—Ä—à—Ä—É—Ç –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞. –ï—Å–ª–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ —à–∞–≥ review —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –æ—à–∏–±–∫–∏ –∏ –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É.

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ –º–∞—Ä—à—Ä—É—Ç –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫—ç—à –∫–æ—Ä–∑–∏–Ω—ã –∏ –∑–∞–∫–∞–∑–∞, —É–¥–∞–ª—è–µ—Ç cookie –∫–æ—Ä–∑–∏–Ω—ã –∏ –¥–µ–ª–∞–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Äî —ç—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –æ–ø—ã—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–∏—Ç—Ä–∏–Ω—ã.

## –ü—Ä–∏–º–µ—Ä

–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ [Medusa Next.js Starter Template](https://github.com/medusajs/nextjs-starter-medusa) ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ [`examples/payment-robokassa/medusa-storefront`](https://github.com/gorgojs/medusa-plugins/tree/main/examples/payment-robokassa/medusa-storefront).

–ü–æ–ª–Ω—ã–π diff –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ [—Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è](https://github.com/gorgojs/medusa-plugins/compare/%40gorgo/medusa-payment-robokassa%400.0.1...main) ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É **Files changed** –∏ –∏–∑—É—á–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–∞–ø–∫–µ `examples/payment-robokassa/medusa-storefront`. –ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:

```bash
git clone https://github.com/gorgojs/medusa-plugins
cd medusa-plugins
git diff @gorgo/medusa-payment-robokassa@0.0.1...main -- examples/payment-robokassa/medusa-storefront
```

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ‚Äî [–∑–¥–µ—Å—å](https://github.com/gorgojs/medusa-plugins/tree/main/examples/payment-robokassa).

## –õ–∏—Ü–µ–Ω–∑–∏—è

–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ [–ª–∏—Ü–µ–Ω–∑–∏–∏ MIT](LICENSE).
