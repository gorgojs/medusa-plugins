# Начало работы с платежами Т-Касса

В этом документе вы узнаете, как установить и настроить платежный провайдер Т-Касса для Medusa.

## Требования

- Medusa v2.7.0 или выше  
- Node.js v20 или выше  
- Аккаунт Т-Бизнес с подключённым интернет-эквайрингом Т-Касса – [зарегистрируйтесь или войдите](https://www.tbank.ru/kassa/?utm_source=partners_sme&utm_medium=prt.utl&utm_campaign=business.int_acquiring.7-3S975SBSY&partnerId=7-3S975SBSY&agentId=5-B6HGU9OD&agentSsoId=1316b7dd-3a90-4167-9d35-37910431a19c)

## Установка

```bash
yarn add @gorgo/medusa-payment-tkassa
# или
npm install @gorgo/medusa-payment-tkassa
```

## Настройка

Добавьте конфигурацию провайдера в файл `medusa-config.js` в приложении Medusa Admin:

```ts
// ...
module.exports = defineConfig({
  // ...
  modules: [
    {
      resolve: "@medusajs/medusa/payment",
      options: {
        providers: [
          {
            resolve: "@gorgo/medusa-payment-tkassa/providers/payment-tkassa",
            id: "tkassa",
            options: {
              terminalKey: process.env.TKASSA_TERMINAL_KEY,
              password: process.env.TKASSA_PASSWORD,
              capture: true,
              useReceipt: true,
              ffdVersion: "1.05",
              taxation: "osn",
              taxItemDefault: "none",
              taxShippingDefault: "none"
            },
          }   
        ]
      }
    }
  ]
})
```

Добавьте переменные окружения `TerminalKey` и `Password` из личного кабинета Т-Бизнес:

```text
TKASSA_TERMINAL_KEY=123456789
TKASSA_PASSWORD=supersecret
```

## Параметры провайдера

| Параметр             | Описание                                                                                                                                                                                                                                                                         | Обязательный | По умолчанию |
| -------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------ | ------------ |
| `terminalKey`        | Ключ терминала, предоставленный T-Kassa (обязателен для аутентификации)                                                                                                                                                                                                          | Да           | -            |
| `password`           | Пароль для подписи запросов (обязателен для аутентификации)                                                                                                                                                                                                                      | Да           | -            |
| `capture`            | Определяет тип проведения платежа:<br/>- `true` — одностадийная оплата (`O` в API)<br/>- `false` — двухстадийная оплата (`T` в API)                                                                                                                                                | Нет          | `true`       |
| `useReceipt`         | Включает формирование онлайн-чеков по 54-ФЗ                                                                                                                                                                                                                                      | Нет          | `false`      |
| `ffdVersion`         | Версия ФФД: `1.2` или `1.05`<br/>Применимо только при `useReceipt=true`                                                                                                                                                                                                           | Нет          | -            |
| `taxation`           | Система налогообложения:<br/>- `osn` — общая СН<br/>- `usn_income` — упрощенная СН (доходы)<br/>- `usn_income_outcome` — упрощенная СН (доходы минус расходы)<br/>- `esn` — единый сельскохозяйственный налог<br/>- `patent` — патентная СН<br/>Применимо только при `useReceipt=true` | Нет          | -            |
| `taxItemDefault`     | Ставка НДС по товарам:<br/>- `none` — без НДС<br/>- `vat0` — 0%<br/>- `vat5` — 5%<br/>- `vat7` — 7%<br/>- `vat10` — 10%<br/>- `vat20` — 20%<br/>- `vat105` — 5/105<br/>- `vat107` — 7/107<br/>- `vat110` — 10/110<br/>- `vat120` — 20/120<br/>Применимо только при `useReceipt=true`        | Нет          | -            |
| `taxShippingDefault` | Ставка НДС для доставки (аналогично `taxItemDefault`)<br/>Применимо только при `useReceipt=true`                                                                                                                                                                                  | Нет          | -            |


## Настройка вебхуков

Чтобы корректно обрабатывать платёжные уведомления от T-Kassa, настройте вебхуки в своём аккаунте T-Business следующим образом:

1. Перейдите в раздел `Интернет-эквайринг` → `Магазины` → Выберите свой магазин → `Терминалы` → Выберите `Тестовый` или `Рабочий` терминал → Нажмите `Настройки`, чтобы открыть окно настроек.

2. Установите отправку уведомлений `По протоколу HTTP`.

3. Укажите URL вида:

    ```
    https://{YOUR_MEDUSA_DOMAIN}/hooks/payment/tkassa_tkassa
    ```

    Замените `{YOUR_MEDUSA_DOMAIN}` на домен вашей витрины Medusa.

> **Внимание!** T-Kassa ожидает сообщение `OK` в ответе, чтобы подтвердить успешную обработку вебхука и избежать повторных уведомлений. В настоящее время Medusa не поддерживает кастомные ответные сообщения вебхуков «из коробки», но сами вебхуки обрабатываются корректно и без этого. Подробнее см. [связанное обсуждение](https://github.com/medusajs/medusa/discussions/12887).
